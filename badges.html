<!DOCTYPE html>

<link href="DataTables/datatables.min.css" rel="stylesheet">
 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MapleRoyals Islander Ranking: Badges</title>
    <link rel="icon" href="https://ik.imagekit.io/islander/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="islander.css">

</head>
<body>

<img src="https://ik.imagekit.io/islander/images/title.png" id="titleImage"></img>

<div id="navbar"></div>

<div id="badges-container"></div>

<div class="BadgeHover" id="sharedTooltip">
    <div id="tooltipTitle"></div>
    <div id="tooltipDesc"></div>
    <div id="tooltipOwn"></div>
</div>

<div id="footer">
    <p>Page written and maintained by <img src="https://ik.imagekit.io/islander/images/shy.png"></p> 
</div>

<script>

//navbar code
fetch('/navbar.html')
    .then(response => response.text())
    .then(data => {
        document.getElementById('navbar').innerHTML = data;
        const currentPage = location.pathname;
        document.querySelectorAll('#navbar a').forEach(link => {
            //console.log("href:" + link.getAttribute('href') + "   currentpage:" + currentPage);
            if (link.getAttribute('href') === currentPage) {
                link.classList.add("navInactive");
                link.removeAttribute('href');
            }
        });
    }).catch(error => console.error('Error loading navbar:', error));

// Function to create and populate the table
function createTable(jsons) {
    data = jsons[0];
    badges = jsons[1];
    // Do a pass through badges, adding ownedBy
    badges.forEach(badge => {
        badge.ownedBy = [];
    });

    // For each islander, populate appropriate badges' ownedBy
    data.forEach(islander => {
        if(islander.hasOwnProperty('Badges')) {
            islander.Badges.forEach(badge => {
                const foundBadge = badges.find(bdg => bdg.id === badge);
                foundBadge.ownedBy.push(islander.Name);
            })
        }
    });

    // For each badge, put it in the table 
    const container = document.getElementById('badges-container');
    badges.forEach(badge => {
        if(!badge.hasOwnProperty('hidden') || badge.hidden == false) {
            const div = document.createElement('div');
            const img = document.createElement('img');
            const tooltip = 'data-tooltip';
            const title = 'data-title';
            const ownedby = 'data-ownedby';
            div.classList.add("BadgeContainer");
            div.setAttribute(title, "♦ "+ badge.name + " ♦");          
            div.setAttribute(tooltip,badge.desc);
            div.setAttribute(ownedby, "Owned by: " + badge.ownedBy.join(', '));
            img.classList.add("Badge");
            img.src = 'https://ik.imagekit.io/islander/images/badges/' + badge.id + '.png';
            div.appendChild(img);
            container.appendChild(div);
        }
    });

    // Badge Tooltip Code
    const tooltip = document.getElementById('sharedTooltip');
    const tooltipTitle = document.getElementById('tooltipTitle');
    const tooltipDesc = document.getElementById('tooltipDesc');
    const tooltipOwn = document.getElementById('tooltipOwn');
    const badgeContainers = document.querySelectorAll('.BadgeContainer');

    badgeContainers.forEach(container => {
        container.addEventListener('mouseenter', () => {
            const rect = container.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + 8}px`;
            tooltip.style.left = `${rect.left}px`;
            tooltipDesc.textContent = container.dataset.tooltip;
            tooltipOwn.textContent = container.dataset.ownedby;
            tooltipTitle.textContent = container.dataset.title;
            void tooltip.offsetWidth;
            tooltip.classList.add('visible');
        });

        container.addEventListener('mouseleave', () => {
        tooltip.classList.remove('visible');
        });
    });
}

async function getJsonData() {
    const jsons = ["islanders.json", "badges.json"];
    const reqs = jsons.map(u=>fetch(u).then(response => {
    if(!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
    })
    );

    const results = await Promise.all(reqs);

    createTable(results);
}

getJsonData();

</script>

</body>
</html>