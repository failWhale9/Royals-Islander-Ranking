<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MapleRoyals Islander Ranking - Detail</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="islander.css">
    <link href="/Lightbox2/src/css/lightbox.css" rel="stylesheet" />

</head>
<body>

<img src="https://ik.imagekit.io/islander/images/title.png" id="titleImage"></img>

<div id="navbar"></div>

<div class="profileContainer">
    <div class="topRow">
        <div class="detailSide">
            <div class="detailRow" id="detail1">
                <span class="detailBox" id="dlvl">Lv.50</span>
                <span class="detailBox" id="dname">Testlander</span>
            </div>

            <div class="detailBoxShort" id="detail2" style="display:none">
                <span id="dbad">Badnews</span>
            </div>

            <div class="detailBoxShort" id="detail3" style="display:none">
                <span id="dalias">Previous names:</span>
            </div>

            <div class="detailBoxShort" id="detail4" style="display:none">
                <span id="dalt">Alts</span>
            </div>

            <div class="detailBoxShort" id="detail5">
                <span id="drank"></span>
            </div>
            <div class="detailBoxShort" id="detail6" style="display:none">
                <span id="dstart">Islanding Since 2020</span>
            </div>
        </div>

        <div class="detailBox" id="dportContainer">
            <img id="dport" src="">
        </div>
    </div>
    <div class="detailBox" id="dbio" style="display:none">Bio:<br/></div>
    <div class="detailBox" id="dbadges">Badges:<br/></div>
    <div class="detailBox image-set" id="dgallery">Gallery:<br/></div>
</div>

<div class="BadgeHover" id="sharedTooltip">
    <div id="tooltipTitle"></div>
    <span id="tooltipDesc"></span>
</div>

<div id="footer">
    <p>Page written and maintained by <img src="https://ik.imagekit.io/islander/images/shy.png"></p> 
</div>

<script src="Lightbox2/dist/js/lightbox-plus-jquery.js"></script>
<script>

function getRandomInteger(min, max) {
    min = Math.ceil(min); 
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function createTable(jsons) {
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('n');
    const gallery = jsons[2].sort((a, b) => {
        const valA = a["year"];
        const valB = b["year"];
        return valB - valA;
    });
    const badges = jsons[1];
    const islanders = jsons[0].filter(item => !item.hasOwnProperty('BadNews')).sort((a, b) => {
        const valA = a["Level"];
        const valB = b["Level"];
        return valB - valA;
    });
    const character = islanders.find(item => item.Name.toLowerCase() === name);
    const rank = islanders.findIndex(item => item.Name.toLowerCase() === name)+1;
    const dname = document.getElementById('dname');
    const dlvl = document.getElementById('dlvl');
    const dbad = document.getElementById('dbad');
    const dalias = document.getElementById('dalias');
    const dalt = document.getElementById('dalt');
    const dport = document.getElementById('dport');
    const dportcontainer = document.getElementById('dportContainer');
    const dstart = document.getElementById('dstart');
    const dbadges = document.getElementById('dbadges');
    const dgallery = document.getElementById('dgallery');
    const dbio = document.getElementById('dbio');
    const detail1 = document.getElementById('detail1');
    const detail2 = document.getElementById('detail2');
    const detail3 = document.getElementById('detail3');
    const detail4 = document.getElementById('detail4');
    const detail5 = document.getElementById('detail5');
    const detail6 = document.getElementById('detail6');

    

    lightbox.option({
        'resizeDuration': 200,
        'imageFadeDuration': 200
    })

    if(character == null) {
        dlvl.style.display = "none";
        detail5.style.display = "none";
        dportcontainer.style.display = "none";
        dbadges.style.display = "none";
        dgallery.style.display = "none";
        dname.textContent = "Character not Found.";
    }
    else{
        dname.textContent = character.Name;
        dlvl.textContent = "Lv." + character.Level;

        const baseName = character.Name.toLowerCase();
        const formats = ['png', 'gif'];
        let formatIndex = 0;

        function tryLoadRandom(min, max) {
            const val = getRandomInteger(min,max);
            dport.src = `https://ik.imagekit.io/islander/images/islanders/${baseName}${val}.png`;
        }

        function tryLoadImage() {
            if (formatIndex < formats.length) {
                try {
                    dport.src = `https://ik.imagekit.io/islander/images/islanders/${baseName}.${formats[formatIndex]}`;
                }
                catch {

                }
                dport.onerror = () => {
                    formatIndex++;
                    tryLoadImage(); // Try next format
                };
            } else {
                dport.onerror = null; // Prevent loop
                dport.src = 'https://ik.imagekit.io/islander/images/placeholder.png'; // Fallback image
            }
        }

        if(baseName == "mooshy") {
            tryLoadRandom(0,31);
        }
        else {
            tryLoadImage();
        }

        if(character.BadNews != null) {
            dbad.textContent = character.BadNews;
            detail2.style.display = "block";
        }

        if(character.Alias != null) {
            dalias.textContent = "Previous names: " + character.Alias;
            detail3.style.display = "block";
        }
        
        if(character.Alt != null) {
            dalt.textContent = "(" + character.Alt + "'s Alt)";
            detail4.style.display = "block";
        }

        detail5.textContent = "Rank #" + rank;

        if(character.Since != null) {
            dstart.textContent = "Islanding Since " + character.Since;
            detail6.style.display = "block";
        }

        // Fetch badges
        if (character.hasOwnProperty('Badges') && character['Badges'] !== "")
        {
            const badgeType = ["build","achievement","item"];
            badgeType.forEach(function(type){
            character['Badges'].forEach(function(badge){
                const targetBadge = badges.find(item => item.id === badge)
                if(targetBadge.id === badge ) {
                    if(targetBadge.type === type)
                    {
                        const div = document.createElement('div');
                        const img = document.createElement('img');
                        const tooltip = 'data-tooltip';
                        const title = 'data-title';
                        div.classList.add("BadgeContainer");
                        div.setAttribute(title, "♦ "+ targetBadge.name + " ♦");          
                        div.setAttribute(tooltip,targetBadge.desc);
                        img.classList.add("Badge");
                        img.src = 'https://ik.imagekit.io/islander/images/badges/' + badge + '.png';
                        div.appendChild(img);
                        dbadges.appendChild(div);
                    }
                }
            })})
            applyBadgeTooltips();
        }
        else {
            dbadges.style.display = "none";
        }

        if(character.Bio != null) {
            dbio.textContent = character.Bio;
            dbio.style.display = "block";
        }

        let picCount = 0;
        let aliases = [];

        // get aliases
        if(character.Alias != null) {
            let anames = [];
            anames = character.Alias.split(",");
            anames = anames.map(item => item.trim());
            anames = anames.map(item => item.toLowerCase());
            aliases = anames;
        }

        // Get gallery images
        gallery.forEach(picture => {
            if(picture.ppl.includes(name) || aliases.some(element => picture.ppl.includes(element))) {
                picCount += 1;
                const pic = document.createElement('a');
                const thumb = document.createElement('img');
                const yrbox = document.createElement('div');
                const data1 = 'data-lightbox';
                const data2 = 'data-title';
                yrbox.textContent = picture.year;
                yrbox.classList.add("gyyear");
                thumb.src = "https://ik.imagekit.io/islander/images/gallery/" + picture.src + "?tr=h-80";
                thumb.classList.add("gythumb");
                pic.href = "https://ik.imagekit.io/islander/images/gallery/" + picture.src;
                pic.classList.add("gycont");
                pic.setAttribute(data1,name);
                if(picture.hasOwnProperty('caption')) {
                    pic.setAttribute(data2,picture.caption);
                }
                else {
                    pic.setAttribute(data2,picture.year);
                }
                
                pic.appendChild(thumb);
                pic.appendChild(yrbox);
                dgallery.appendChild(pic);
            }
        });

        if(picCount == 0) {
            dgallery.style.display = "none";
        }

    }

}

//navbar code
fetch('/navbar.html')
    .then(response => response.text())
    .then(data => {
        document.getElementById('navbar').innerHTML = data;
        const currentPage = location.pathname;
        document.querySelectorAll('#navbar a').forEach(link => {
            //console.log("href:" + link.getAttribute('href') + "   currentpage:" + currentPage);
            if (link.getAttribute('href') === currentPage) {
                link.classList.add("navInactive");
                link.removeAttribute('href');
            }
        });
    }).catch(error => console.error('Error loading navbar:', error));

// badge tooltip code
function applyBadgeTooltips() {
    const tooltip = document.getElementById('sharedTooltip');
    const tooltiptitle = document.getElementById('tooltipTitle');
    const tooltipdesc = document.getElementById('tooltipDesc');
    const badgeContainers = document.querySelectorAll('.BadgeContainer');

    badgeContainers.forEach(container => {
        container.addEventListener('mouseenter', () => {
            const rect = container.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + 8}px`;
            tooltip.style.left = `${rect.left}px`;
            tooltipDesc.textContent = container.dataset.tooltip;
            tooltiptitle.textContent = container.dataset.title;
            void tooltip.offsetWidth;
            tooltip.classList.add('visible');
        });

        container.addEventListener('mouseleave', () => {
        tooltip.classList.remove('visible');
        });
    });
}

// json code
async function getJsonData() {
    const jsons = ["islanders.json", "badges.json", "gallery.json"];
    const reqs = jsons.map(u=>fetch(u).then(response => {
    if(!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
    })
    );

    const results = await Promise.all(reqs);

    createTable(results);
}

getJsonData();

</script>
</body>
</html>