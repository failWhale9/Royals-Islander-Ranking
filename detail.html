<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MapleRoyals Islander Ranking - Detail</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="islander.css">

</head>
<body>

<img src="images/title.png" id="titleImage"></img>

<div id="navbar"></div>

<div class="profileContainer">
    <div class="topRow">
        <div class="detailSide">
            <div class="detailRow" id="detail1">
                <span class="detailBox" id="dlvl">Lv.50</span>
                <span class="detailBox" id="dname">Testlander</span>
            </div>

            <div class="detailBoxShort" id="detail2" style="display:none">
                <span id="dbad">Badnews</span>
            </div>

            <div class="detailBoxShort" id="detail3" style="display:none">
                <span id="dalias">Previous names:</span>
            </div>

            <div class="detailBoxShort" id="detail4" style="display:none">
                <span id="dalt">Alts</span>
            </div>

            <div class="detailBoxShort" id="detail5" style="display:none">
                <span id="dstart">Islanding Since 2020</span>
            </div>
        </div>

        <div class="detailBox" id="dportContainer">
            <img id="dport" src="">
        </div>
    </div>

    <div class="detailBox" id="dbadges">Badges:<br/></div>
    <div class="detailBox" id="dgallery">Gallery:</div>
</div>

<div class="BadgeHover" id="sharedTooltip">
    <div id="tooltipTitle"></div>
    <span id="tooltipDesc"></span>
</div>

<div id="footer">
    <p>Page written and maintained by <img src="/images/shy.png"></p> 
</div>

<script>

function createTable(jsons) {
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('n');
    const badges = jsons[1];
    const character = jsons[0].find(item => item.Name.toLowerCase() === name);
    const dname = document.getElementById('dname');
    const dlvl = document.getElementById('dlvl');
    const dbad = document.getElementById('dbad');
    const dalias = document.getElementById('dalias');
    const dalt = document.getElementById('dalt');
    const dport = document.getElementById('dport');
    const dstart = document.getElementById('dstart');
    const dbadges = document.getElementById('dbadges');
    const detail1 = document.getElementById('detail1');
    const detail2 = document.getElementById('detail2');
    const detail3 = document.getElementById('detail3');
    const detail4 = document.getElementById('detail4');
    const detail5 = document.getElementById('detail5');

    if(character == null) {
        console.log("Character not found");
    }
    else{
        dname.textContent = character.Name;
        dlvl.textContent = "Lv." + character.Level;

        const baseName = character.Name.toLowerCase();
        const formats = ['png', 'gif'];
        let formatIndex = 0;

        function tryLoadImage() {
            if (formatIndex < formats.length) {
                try {
                    dport.src = `images/islanders/${baseName}.${formats[formatIndex]}`;
                }
                catch {

                }
                dport.onerror = () => {
                    formatIndex++;
                    tryLoadImage(); // Try next format
                };
            } else {
                dport.onerror = null; // Prevent loop
                dport.src = 'images/placeholder.png'; // Fallback image
            }
        }

        tryLoadImage();

        if(character.BadNews != null) {
            dbad.textContent = character.BadNews;
            detail2.style.display = "block";
        }

        if(character.Alias != null) {
            dalias.textContent = "Previous names: " + character.Alias;
            detail3.style.display = "block";
        }
        
        if(character.Alt != null) {
            dalt.textContent = "(" + character.Alt + "'s Alt)";
            detail4.style.display = "block";
        }

        if(character.Since != null) {
            dstart.textContent = "Islanding Since " + character.Since;
            detail5.style.display = "block";
        }

        // Fetch badges
        if (character.hasOwnProperty('Badges') && character['Badges'] !== "")
        {
            const badgeType = ["build","achievement","item"];
            badgeType.forEach(function(type){
            character['Badges'].forEach(function(badge){
                const targetBadge = badges.find(item => item.id === badge)
                if(targetBadge.id === badge ) {
                    if(targetBadge.type === type)
                    {
                        const div = document.createElement('div');
                        const img = document.createElement('img');
                        const tooltip = 'data-tooltip';
                        const title = 'data-title';
                        div.classList.add("BadgeContainer");
                        div.setAttribute(title, "♦ "+ targetBadge.name + " ♦");          
                        div.setAttribute(tooltip,targetBadge.desc);
                        img.classList.add("Badge");
                        img.src = '/images/badges/' + badge + '.png';
                        div.appendChild(img);
                        dbadges.appendChild(div);
                    }
                }
            })})
            applyBadgeTooltips();
        }
    }

}

//navbar code
fetch('/navbar.html')
    .then(response => response.text())
    .then(data => {
        document.getElementById('navbar').innerHTML = data;
        const currentPage = location.pathname;
        document.querySelectorAll('#navbar a').forEach(link => {
            //console.log("href:" + link.getAttribute('href') + "   currentpage:" + currentPage);
            if (link.getAttribute('href') === currentPage) {
                link.classList.add("navInactive");
                link.removeAttribute('href');
            }
        });
    }).catch(error => console.error('Error loading navbar:', error));

// badge tooltip code
function applyBadgeTooltips() {
    const tooltip = document.getElementById('sharedTooltip');
    const tooltiptitle = document.getElementById('tooltipTitle');
    const tooltipdesc = document.getElementById('tooltipDesc');
    const badgeContainers = document.querySelectorAll('.BadgeContainer');

    badgeContainers.forEach(container => {
        container.addEventListener('mouseenter', () => {
            const rect = container.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + 8}px`;
            tooltip.style.left = `${rect.left}px`;
            tooltipDesc.textContent = container.dataset.tooltip;
            tooltiptitle.textContent = container.dataset.title;
            void tooltip.offsetWidth;
            tooltip.classList.add('visible');
        });

        container.addEventListener('mouseleave', () => {
        tooltip.classList.remove('visible');
        });
    });
}

// json code
async function getJsonData() {
    const jsons = ["islanders.json", "badges.json"];
    const reqs = jsons.map(u=>fetch(u).then(response => {
    if(!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
    })
    );

    const results = await Promise.all(reqs);

    createTable(results);
}

getJsonData();

</script>

</body>
</html>